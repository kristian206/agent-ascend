rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isGod() {
      return isAuthenticated() && 
        request.auth.token.email == 'kristian.suson@gmail.com';
    }
    
    function isTeamMember(teamId) {
      return isAuthenticated() && 
        request.auth.uid in get(/databases/$(database)/documents/teams/$(teamId)).data.members;
    }
    
    function isTeamLeader(teamId) {
      return isAuthenticated() && 
        request.auth.uid == get(/databases/$(database)/documents/teams/$(teamId)).data.leaderId;
    }
    
    // Validate data types and required fields
    function hasRequiredUserFields() {
      return request.resource.data.keys().hasAll(['email', 'name', 'userId']) &&
        request.resource.data.email is string &&
        request.resource.data.name is string &&
        request.resource.data.userId is string;
    }
    
    // Rate limiting helper (basic implementation)
    function withinRateLimit() {
      return request.time > resource.data.lastModified + duration.value(1, 's');
    }
    
    // Users collection - CRITICAL FOR ONBOARDING
    match /users/{userId} {
      // Allow authenticated users to read their own document (even if it doesn't exist yet)
      allow read: if isOwner(userId) || isGod();
      
      // Allow users to create their own document during signup/onboarding
      allow create: if isAuthenticated() && request.auth.uid == userId;
      
      // Users can update their own profile
      allow update: if isOwner(userId) || isGod();
      
      // Only gods can delete users
      allow delete: if isGod();
    }
    
    // Members collection (legacy support - same rules as users)
    match /members/{userId} {
      // Allow read even if document doesn't exist
      allow read: if isOwner(userId) || isGod();
      
      // Allow users to create their own document
      allow create: if isAuthenticated() && request.auth.uid == userId;
      
      // Users can update their own profile
      allow update: if isOwner(userId) || isGod();
      
      // Only gods can delete
      allow delete: if isGod();
    }
    
    // Teams collection
    match /teams/{teamId} {
      // Allow authenticated users to read teams (for browsing/joining)
      // This is needed for onboarding team selection
      allow read: if isAuthenticated();
      
      // Only team leaders can update
      allow update: if isTeamLeader(teamId) || isGod();
      
      // Authenticated users can create teams
      allow create: if isAuthenticated() && 
        request.resource.data.leaderId == request.auth.uid &&
        request.resource.data.members.hasAll([request.auth.uid]);
      
      // Only team leaders or gods can delete
      allow delete: if isTeamLeader(teamId) || isGod();
    }
    
    // Activities collection
    match /activities/{activityId} {
      // Users can read their own activities or if document doesn't exist yet
      allow read: if isAuthenticated() && 
        (resource == null || resource.data.userId == request.auth.uid || isGod());
      
      // Users can create their own activities
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      
      // Activities cannot be updated
      allow update: if false;
      
      // Only gods can delete activities
      allow delete: if isGod();
    }
    
    // Notifications collection
    match /notifications/{notificationId} {
      // Users can read their own notifications or if document doesn't exist
      allow read: if isAuthenticated() && 
        (resource == null || resource.data.recipientId == request.auth.uid);
      
      // Users can create notifications
      allow create: if isAuthenticated() &&
        request.resource.data.recipientId != null;
      
      // Users can mark their own as read
      allow update: if isAuthenticated() && 
        resource.data.recipientId == request.auth.uid &&
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['read', 'readAt']);
      
      // Users can delete their own notifications
      allow delete: if isAuthenticated() && 
        resource.data.recipientId == request.auth.uid;
    }
    
    // Achievements collection
    match /achievements/{achievementId} {
      // All authenticated users can read achievements
      allow read: if isAuthenticated();
      
      // Only gods can manage achievements
      allow create, update, delete: if isGod();
    }
    
    // Sales collection
    match /sales/{saleId} {
      // Users can read their own sales or if document doesn't exist
      allow read: if isAuthenticated() && 
        (resource == null || resource.data.userId == request.auth.uid || 
         (resource.data.teamId != null && isTeamLeader(resource.data.teamId)) || 
         isGod());
      
      // Users can log their own sales
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      
      // Users can update their own recent sales, leaders can verify
      allow update: if (isAuthenticated() && 
        resource.data.userId == request.auth.uid &&
        resource.data.timestamp > request.time - duration.value(24, 'h')) ||
        (resource.data.teamId != null && isTeamLeader(resource.data.teamId)) ||
        isGod();
      
      // Only gods can delete sales
      allow delete: if isGod();
    }
    
    // Daily Intentions collection
    match /dailyIntentions/{intentionId} {
      // Users can read intentions
      allow read: if isAuthenticated();
      
      // Users can create their own intentions
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      
      // Users can update their own intentions from today
      allow update: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      
      // Only gods can delete
      allow delete: if isGod();
    }
    
    // Nightly Wraps collection
    match /nightlyWraps/{wrapId} {
      // Users can read wraps
      allow read: if isAuthenticated();
      
      // Users can create their own wraps
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      
      // Users can update their own wraps from today
      allow update: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      
      // Only gods can delete
      allow delete: if isGod();
    }
    
    // Check-ins collection
    match /checkins/{checkinId} {
      // Users can read check-ins
      allow read: if isAuthenticated();
      
      // Users can create their own check-ins
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      
      // Check-ins cannot be updated
      allow update: if false;
      
      // Only gods can delete
      allow delete: if isGod();
    }
    
    // Config collection (system configuration)
    match /config/{document=**} {
      // All authenticated users can read config
      allow read: if isAuthenticated();
      
      // Only gods can modify config
      allow write: if isGod();
    }
    
    // Settings collection
    match /settings/{document=**} {
      // All authenticated users can read settings
      allow read: if isAuthenticated();
      
      // Only gods can modify settings
      allow write: if isGod();
    }
    
    // Badges collection
    match /badges/{badgeId} {
      // All authenticated users can read badges
      allow read: if isAuthenticated();
      
      // Only gods can manage badges
      allow create, update, delete: if isGod();
    }
    
    // Leaderboard collection
    match /leaderboard/{entry} {
      // All authenticated users can read leaderboard
      allow read: if isAuthenticated();
      
      // System updates leaderboard
      allow create, update: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      
      // No deletion allowed
      allow delete: if false;
    }
    
    // User Stats collection
    match /userStats/{userId} {
      // Users can read their own stats
      allow read: if isAuthenticated() && 
        request.auth.uid == userId;
      
      // System/user can create and update stats
      allow create, update: if isAuthenticated() && 
        request.auth.uid == userId;
      
      // No deletion allowed
      allow delete: if false;
    }
    
    // Team Stats collection
    match /teamStats/{teamId} {
      // Team members can read team stats
      allow read: if isAuthenticated();
      
      // Team leaders can update team stats
      allow create, update: if isAuthenticated();
      
      // No deletion allowed
      allow delete: if false;
    }
    
    // Monthly Totals collection
    match /monthlyTotals/{totalId} {
      // Users can read monthly totals
      allow read: if isAuthenticated();
      
      // System/users can create and update their own totals
      allow create, update: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      
      // No deletion allowed
      allow delete: if false;
    }
    
    // Team Activities collection
    match /teamActivities/{activityId} {
      // Team members can read team activities
      allow read: if isAuthenticated();
      
      // Team members can create activities
      allow create: if isAuthenticated();
      
      // No updates allowed
      allow update: if false;
      
      // Only gods can delete
      allow delete: if isGod();
    }
    
    // Audit logs (write-only for system, read for gods)
    match /audit/{logId} {
      allow read: if isGod();
      allow create: if isAuthenticated() &&
        request.resource.data.timestamp == request.time &&
        request.resource.data.userId == request.auth.uid;
      allow update, delete: if false;
    }
    
    // Rate limits collection (for Cloud Functions)
    match /rateLimits/{email} {
      // Cloud Functions service account can read/write
      // Regular users cannot access this collection
      allow read, write: if false;
    }
    
    // Default deny all
    match /{document=**} {
      allow read, write: if false;
    }
  }
}